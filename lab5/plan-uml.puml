@startuml
skinparam componentStyle rectangle
skinparam packageStyle rectangle

actor "User"  as UserActor
actor "Admin" as AdminActor

() "HTTP API" as IHTTP

UserActor --> IHTTP
AdminActor --> IHTTP

package "Movie Streaming Backend" {

  ' ================= API SERVER =================
  [HTTP Router]        as HttpRouter
  [EntryPoint Config]  as EPConfig
  [Request Validator]  as Validator
  [JSON Schema Validator] as JsonValidator
  [Auth Middleware]    as AuthCore

  IHTTP - HttpRouter

  HttpRouter --> EPConfig
  HttpRouter --> Validator
  HttpRouter --> AuthCore
  Validator --> JsonValidator


  ' ================= MOVIE MODULE =================
  package "Movie Module" {
    [MovieController]
    [MovieService]
    [MovieRepository]       
    [ActorRepository]       
    [DirectorRepository]    
    [PerformanceRepository]  
  }

  ' ================= PAYMENT MODULE =================
  package "Payment Module" {
    [PaymentController]
    [PaymentService]
    [PaymentRepository]     
  }

  ' ================= AUTH MODULE =================
  package "Auth Module" {
    [AuthController]
    [AuthService]
    [AuthRepository]        
  }

  ' ================= USER MODULE =================
  package "User Module" {
    [UserController]
    [UserService]
    [UserRepository]         
  }

  ' ================= SUBSCRIPTION MODULE =================
  package "Subscription Module" {
    [SubscriptionController]
    [SubscriptionService]
    [SubscriptionPlanRepository]  
    [IncludedMovieRepository]      
    [UserSubscriptionRepository]   
  }

  ' ================= NOTIFICATION MODULE =================
  package "Notification Module" {
    [EmailSender]          
  }

  ' ================= DATABASE =================
  [DB Connection Pool] as DbPool
  database "PostgreSQL" as DB
  DbPool --> DB
}

' -------- ROUTER → MODULE ENTRYPOINTS --------
HttpRouter --> MovieController
HttpRouter --> PaymentController
HttpRouter --> AuthController
HttpRouter --> UserController
HttpRouter --> SubscriptionController

Validator --> MovieController
Validator --> PaymentController
Validator --> AuthController
Validator --> UserController
Validator --> SubscriptionController

AuthCore --> MovieController
AuthCore --> UserController
AuthCore --> SubscriptionController
AuthCore --> PaymentController

' -------- CONTROLLER → SERVICE --------
MovieController         --> MovieService
PaymentController       --> PaymentService
AuthController          --> AuthService
UserController          --> UserService
SubscriptionController  --> SubscriptionService

' -------- SERVICE → REPOSITORIES --------
MovieService --> MovieRepository
MovieService --> ActorRepository
MovieService --> DirectorRepository
MovieService --> PerformanceRepository

PaymentService --> PaymentRepository

AuthService  --> AuthRepository
UserService  --> UserRepository

SubscriptionService --> SubscriptionPlanRepository
SubscriptionService --> IncludedMovieRepository
SubscriptionService --> UserSubscriptionRepository

' -------- REPOSITORIES → DB POOL --------
MovieRepository        --> DbPool
ActorRepository        --> DbPool
DirectorRepository     --> DbPool
PerformanceRepository  --> DbPool
PaymentRepository      --> DbPool
AuthRepository         --> DbPool
UserRepository         --> DbPool
SubscriptionPlanRepository  --> DbPool
IncludedMovieRepository     --> DbPool
UserSubscriptionRepository  --> DbPool

' -------- CROSS-MODULE CALLS --------
[StreamingService] as StreamingService

StreamingService --> MovieService        : loadMovie()
StreamingService --> SubscriptionService : checkActiveSubscription()

PaymentService   --> SubscriptionService : updateSubscriptionStatus()
SubscriptionService --> EmailSender      : sendSubscriptionEmail()

' -------- EXTERNAL SYSTEMS --------
[Payment Provider]      as PaymentExt
[Google Auth 2.0]       as GoogleExt
[Email Gateway]         as EmailExt

PaymentService --> PaymentExt
AuthService    --> GoogleExt
EmailSender    --> EmailExt

@enduml
