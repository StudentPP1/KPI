@startuml
title Buy user subscription
autonumber

actor User
participant Application
participant "Payment Service" as PS
participant "Subscription Service" as SP
database "DB" as DB

User -> Application : get all subscription plans
activate Application
Application -> Application : validate authentication
Application -> SP : fetch all subscription plans
activate SP
SP -> SP : validate request
SP -> DB : select all active subscription plans
DB --> SP : return subscription plans
SP --> Application : return subscription plan dtos
deactivate SP
Application --> User : return subscription plan dtos
deactivate Application

User -> Application : choose subscription plan
activate Application
Application -> SP : validate subscription plan
activate SP
SP -> DB : select plan by id
DB --> SP : return subscription plan
SP -> SP : check plan status and constraints
SP --> Application : return subscription plan dto
deactivate SP

Application -> PS : request payment form
activate PS
PS --> Application : return payment form
deactivate PS
Application --> User : return payment form
deactivate Application

User -> PS : open payment form and input payment data
activate PS
PS -> PS : validate payment data and perform transaction

alt payment success
  PS --> Application : send success notification
  activate Application
  Application -> DB : create payment record(status=SUCCESS)
  DB --> Application : ok
  Application -> DB : create user subscription(status=ACTIVE)
  DB --> Application : ok
  Application --> User : return success message
  deactivate Application
else payment failed
  PS --> Application : send failed notification
  activate Application
  Application -> DB : create payment record(status=FAILED)
  DB --> Application : ok
  Application --> User : return payment failed(reason)
  deactivate Application
end
deactivate PS

destroy User
destroy Application
destroy PS
destroy SP
destroy DB

@enduml
